---
title: "ISARIC (International Severe Acute Respiratory and Emerging Infections Consortium)"
output:
  pdf_document:
    toc: no
    fig_caption: true
    extra_dependencies: ["subfig"]
    latex_engine: xelatex
    includes:
      in_header: header.tex
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
urlcolor: blue
header-includes:
   - \usepackage{floatrow}
   - \floatsetup[figure]{capposition=top}
params:
  rendered_by_shiny: FALSE
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir="/Users/mdhall/CovidClinicalDataDashboard/")

knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      options(scipen=999))



```

```{r progress1}
if (params$rendered_by_shiny)
  shiny::setProgress(0.2)

```

```{r loading, include = FALSE}


source("global.R")



###### THIS NEEDS AUTOMATION #####

pub.date <- today()
ref.date <- ymd("2021-01-28")


```

*A global federation of clinical research networks, providing a proficient, coordinated, and agile research response to outbreak-prone infectious diseases*


# COVID-19 Report: `r format(pub.date, "%d %B %Y")`  {-}
Containing data extracted 15 February 2021


```{r child ='markdown/Summary.Rmd'}
```


\newpage
```{r cohortoverview,  out.width = "100%", fig.align="center", fig.cap = "Overview of cohort and outcomes as of 15 February 2020."}

flowchart()

```

```{r progress2}
if (params$rendered_by_shiny)
  shiny::setProgress(0.4)
```

\newpage
# Country Comparisons

```{r country_recruitment,out.width = '80%', echo=FALSE,fig.cap = "Distribution of patients by country. This reflects data on only those countries that are contributing data on patients who satisfy the inclusion criteria outlined in the summary section."}

patient.by.country.plot(patient.by.country.input)

```

\newpage
## Patient Characteristics

```{r agepyramid, echo = FALSE, fig.align="center", fig.cap = "Age and sex distribution of patients. Bar fills are outcome (death/discharge/lost to follow-up (LTFU)/ongoing care) at the time of report."}

age.pyramid.plot(age.pyramid.input)

```


\newpage

```{r symptomprev, echo=FALSE, out.width= "100%", fig.height=3.3, message=FALSE, fig.cap='(a) Frequency of symptoms seen at admission amongst COVID-19 patients. Bars are annotated with a fraction representing the number of patients presenting with this symptom over the number of patients for whom presence or absence of this symptom was recorded. (b) The distribution of combinations of the five most common symptoms, amongst all patients for whom these data were recorded. Filled and empty circles below the x-axis indicate the presence or absence of each comorbidity. (c) Heatmap for correlation between symptoms. Fill colour is the phi correlation coefficient for each pair of symptoms, calculated amongst patients with recorded presence or absence of both.'}

symptom.prevalence.plot(symptom.prevalence.input) + ggtitle("(a)")
```

```{r symptomupset, echo=FALSE, out.width= "100%", fig.height = 3.3, message=FALSE}

upset.plot(symptom.upset.input, which.plot = "symptom") + ggtitle("(b)")
```
\newpage

```{r symptomheatmap, echo=FALSE, out.width= "100%", message=FALSE}

heatmap_plot(data_plot_heatmap) + ggtitle("(c)")
```

\newpage

```{r comorbprev, echo=FALSE, out.width= "100%", fig.height=3.3, message=FALSE, fig.cap = "(a) Frequency of comorbidities or other concomitant conditions seen at admission amongst COVID-19 patients. Bars are annotated with a fraction representing the number of patients presenting with this comorbidity over the number of patients for whom presence or absence of this comorbidity was recorded.  (b) The distribution of combinations of the five most common such conditions, amongst all patients for whom these data were recorded. Filled and empty circles below the x-axis indicate the presence or absence of each comorbidity."}
comorbidity.prevalence.plot(comorbidity.prevalence.input) + ggtitle("(a)")
```

```{r comorbupset, echo=FALSE, out.width= "100%", fig.height = 3.3, message=FALSE}
upset.plot(comorbidity.upset.input, which.plot = "comorbidity") + ggtitle("(b)")
```

\newpage

## Variables by age

```{r comorbbyage, echo=FALSE, out.width= "33%", message=FALSE, fig.height=4, fig.ncol = 3, fig.subcap=c("Asthma", "Dementia", "Diabetes mellitus", "Hypertension", "Malignant neoplasm", "Obesity", "Smoking"), fig.cap = "Symptoms recorded at hospital presentation stratified by age group. Boxes show the proportion of individuals with each symptom, with error bars showing 95\\% confidence intervals.  The size of each box is proportional to the number of individuals represented.  N is the number of individuals included in the plot (this varies between plots due to data completeness)"}

plot.prop.by.age_comorbid_asthma(data_plot_comorbid_asthma, FALSE)
plot.prop.by.age_comorbid_dementia(data_plot_comorbid_dementia, FALSE)
plot.prop.by.age_comorbid_diabetes(data_plot_comorbid_diabetes, FALSE)
plot.prop.by.age_comorbid_hypertension(data_plot_comorbid_hypertension, FALSE)
plot.prop.by.age_comorbid_malignant_neoplasm(data_plot_comorbid_malignant_neoplasm, FALSE)
plot.prop.by.age_comorbid_obesity(data_plot_comorbid_obesity, FALSE)
plot.prop.by.age_comorbid_smoking(data_plot_comorbid_smoking, FALSE)

```


```{r sympbyage, echo=FALSE, out.width= "33%", message=FALSE, fig.height=4, fig.ncol = 3, fig.subcap=c("Abdominal pain", "Altered consciousness/confusion", "Constitutional symptoms (myalgia, joint pain, fatigue or headache)", "Cough", "Cough or fever", "Cough, fever or shortness of breath",  "History of fever", "Shortness of breath", "Upper respiratory tract symptoms (runny nose, sore throat or ear pain)","Diarrhoea", "Vomiting or nausea"), fig.cap = 'Symptoms recorded at hospital presentation stratified by age group. Boxes show the proportion of individuals with each symptom, with error bars showing 95\\% confidence intervals.  The size of each box is proportional to the number of individuals represented. N is the number of individuals included in the plot (this varies between plots due to data completeness).'}

plot.prop.by.age_symptoms_abdominal_pain(data_plot_symptoms_abdominal_pain, FALSE)
plot.prop.by.age_symptoms_altered_consciousness_confusion(data_plot_symptoms_altered_consciousness_confusion, FALSE)
plot.prop.by.age_symptoms_constitutional(data_plot_symptoms_constitutional, FALSE)
plot.prop.by.age_symptoms_cough(data_plot_symptoms_cough, FALSE)
plot.prop.by.age_symptoms_cough_fever(data_plot_symptoms_cough_fever, FALSE)
plot.prop.by.age_symptoms_cought_fever_shortness_of_breath(data_plot_symptoms_cought_fever_shortness_of_breath, FALSE)
plot.prop.by.age_symptoms_history_of_fever(data_plot_symptoms_history_of_fever, FALSE)
plot.prop.by.age_symptoms_shortness_of_breath(data_plot_symptoms_shortness_of_breath, FALSE)
plot.prop.by.age_symptoms_upper_respiratory_tract_symptoms(data_plot_symptoms_upper_respiratory_tract_symptoms, FALSE)
plot.prop.by.age_symptoms_diarrhoea(data_plot_symptoms_diarrhoea, FALSE)
plot.prop.by.age_symptoms_vomiting_nausea(data_plot_symptoms_vomiting_nausea, FALSE)



```


```{r labs1, echo=FALSE, out.width= "50%", message=FALSE, fig.height=5, fig.ncol = 2, fig.subcap=c("Respiratory rate", "Heart rate", "Temperature", "Systolic blood pressure", "Oxygen saturation"), fig.cap = "Box and whisker plots for observations at hospital presentation stratified by age group. Outliers are omitted. N is the number of individuals included in the plot (this varies between plots due to data completeness)."}

p_resp(data_plot_vs_resp)
p_hr(data_plot_vs_hr)
p_temp(data_plot_vs_temp)
p_sysbp(data_plot_vs_sysbp)
p_oxysat(data_plot_vs_oxysat)

```

```{r labs2, echo=FALSE, out.width= "50%", message=FALSE, fig.height=3, fig.ncol = 2,  fig.subcap=c("Alanine transaminase (ALT)", "Aspartate transaminase (AST)", "Bilirubin",   "Activated partial thromboplastin time (APTT)", "Protrombin time", "Urea",  "White blood cell count (WCC)", "Neutrophils", "Lymphocytes","C-reactive protein (CRP)"), fig.cap = "Box and whisker plots for laboratory results within 24 hours of hospital presentation stratified by age group. Outliers are omitted. N is the number of individuals included in the plot (this varies between plots due to data completeness)."}

p_lab_alt(data_plot_lab_alt)
p_lab_ast(data_plot_lab_ast)
p_lab_bili(data_plot_lab_bili)
p_lab_aptt(data_plot_lab_aptt)
p_lab_pt(data_plot_lab_pt)
p_lab_urean(data_plot_lab_urean)
p_lab_wbc(data_plot_lab_wbc)
p_lab_neut(data_plot_lab_neut)
p_lab_lym(data_plot_lab_lym)
p_lab_crp(data_plot_lab_crp)
```

```{r progress3}
if (params$rendered_by_shiny)
  shiny::setProgress(0.6)
```


\newpage
## Hospital stays and outcomes

```{r  staybysex, out.width= "80%", fig.height=4, fig.cap="Distribution of length of hospital stay, according to sex. This only includes cases with reported outcomes. The coloured areas indicate the kernel probability density of the observed data and the box plots show the median and interquartile range of the variable of interest."}

length.of.stay.sex.plot(length.of.stay.sex.input)
```

```{r  staybyage, out.width= "80%", fig.height=4, fig.cap = "Distribution of length of hospital stay, according to patient age group. This only includes cases with reported outcomes. The coloured areas indicate the kernel probability density of the observed data and the box plots show the median and interquartile range of the variable of interest."}

length.of.stay.age.plot(length.of.stay.age.input)
```


```{r  admissiontoICUoverall, out.width= "100%", fig.cap = "Distribution of time (in days) from hospital admission to ICU admission. The figure displays data on only those cases with a reported ICU start date."}
admission.to.icu.plot(admission.to.icu.input)
```


```{r  timeline, out.width= "100%", fig.cap = "The distribution of patient status by number of days after admission. Patients with 'unknown' status have left the site at the time of report but have unknown outcomes due to missing data. The black line marks the end of 14 days."}

status.by.time.after.admission.plot(status.by.time.after.admission.input)
```

```{r  statusafteradmission, out.width= "100%", fig.cap = "Cumulative patient numbers and outcomes by epidemiological week (of 2020) of admission (or, for patients infected in hospital, of symptom onset)."}

outcomes.by.admission.date.plot(outcome_admission_date_input)
```

\newpage
## Treatment

```{r treatprev, echo=FALSE, out.width= "100%", fig.height=3.3, message=FALSE, fig.cap = "(a) Treatments used. This only includes patients for whom this information was recorded. (b) The distribution of combinations of antimicrobial treatments and steroids administered during hospital stay, across all patients with completed hospital stay and recorded treatment data."}

treatment.prevalence.plot(treatment.use.proportion.input, icu = FALSE) + ggtitle("(a)")
```

```{r treatupset, echo=FALSE, out.width= "100%", fig.height = 3.3, message=FALSE}

upset.plot(treatment.upset.input, which.plot = "treatment") + ggtitle("(b)")
```

\newpage
# Intensive Care and High Dependency Unit Treatments

```{r treaticuprev,  out.width= "100%", fig.height=3.3, message=FALSE, fig.cap = "(a) Treatments used amongst patients admitted to the ICU. This only includes patients for whom this information was recorded. (b) The distribution of combinations of treatments administered during ICU/HDU stay. Filled and empty circles below the x-axis indicate treatments that were and were not administered respectively. (c) Distribution of lengths of stay for patients who were admitted to ICU/HDU: total length of stay for this group and length of stay within intensive care. This only includes cases with reported completed stays. The coloured areas indicate the kernel probability density of the observed data and the box plots show the median and interquartile range of the variable of interest."}

treatment.prevalence.plot(icu.treatment.use.proportion.input, icu = TRUE) + ggtitle("(a)")
```

```{r treaticuupset, echo=FALSE, out.width= "100%", fig.height = 3.3, message=FALSE}
upset.plot(icu.treatment.upset.input, which.plot = "icu.treatment") + ggtitle("(b)")
```

```{r icu_los,  out.width = '80%', echo=FALSE}
length.of.stay.icu.plot(length.of.stay.icu.input) + ggtitle("(c)")
```


```{r progress4}
if (params$rendered_by_shiny)
  shiny::setProgress(0.8)
```
\newpage
```{r child = 'markdown/Background.Rmd'}
```


```{r child = 'markdown/Methods.Rmd'}
```


```{r child = 'markdown/Caveats.Rmd'}
```

```{r child = 'markdown/Teammembers.Rmd'}
```

```{r child = 'markdown/References.Rmd'}
```


## Summary tables

```{r table1, tab.cap = "Patient Characteristics. Proportions are presented in parentheses, and have been rounded to two decimal places."}
tables_supplementary(table_sup = patient.characteristic.table) 
```


```{r table2, tab.cap = "Outcome by age and sex. Proportions are calculated using the column total as the denominator."}
tables_supplementary(table_sup = outcome.age.sex.table)
```


```{r table3, tab.cap = "Prevalence of symptoms."}
tables_supplementary(table_sup = symptoms.table)
```



```{r table4, tab.cap = "Prevalence of comorbidities."}
tables_supplementary(table_sup = comorbidity.table)
```



```{r table5, tab.cap = "Treatment use. The counts presented for treatments include all cases, not only cases with complete details of treatments (as expressed in the summary)."}
tables_supplementary(table_sup = treatments.table)
```


```{r table6, tab.cap = "Key time variables. SD: Standard deviation; IQR: Interquartile range. Outliers (values greater than 120) were excluded prior to the computation of estimates."}
tables_supplementary(table_sup = key.times.table)

```



